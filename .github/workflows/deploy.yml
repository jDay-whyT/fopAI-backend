name: Deploy

on:
  workflow_dispatch:

env:
  REGION: us-central1
  AR_REPO: fopai
  PUBSUB_TOPIC: tg-raw-ingested
  DB_INSTANCE_CONNECTION_NAME: optimum-tea-481710-u3:us-central1:fopai-postgres
  DB_NAME: fopai

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WIF_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker
        run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev

      - name: Verify required secrets
        run: |
          test -n "${{ secrets.GCP_PROJECT_ID }}" || (echo "Missing GCP_PROJECT_ID secret" && exit 1)

      - name: Preflight Secret Manager
        env:
          PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
        run: |
          set -euo pipefail
          required_secrets=(
            DB_PASSWORD
            OPENAI_API_KEY
            TG_BOT_TOKEN
            TELEGRAM_API_ID
            TELEGRAM_API_HASH
            TELETHON_STRING_SESSION
          )
          missing=()
          no_versions=()

          for secret in "${required_secrets[@]}"; do
            if ! gcloud secrets describe "$secret" --project "$PROJECT_ID" >/dev/null 2>&1; then
              missing+=("$secret")
              continue
            fi

            if ! gcloud secrets versions list "$secret" --project "$PROJECT_ID" \
              --filter="state=ENABLED" --format="value(name)" | head -n1 | grep -q .; then
              no_versions+=("$secret")
            fi
          done

          if (( ${#missing[@]} > 0 || ${#no_versions[@]} > 0 )); then
            echo "Secret Manager preflight check failed."
            if (( ${#missing[@]} > 0 )); then
              echo "Missing secrets: ${missing[*]}"
            fi
            if (( ${#no_versions[@]} > 0 )); then
              echo "Secrets with no enabled versions: ${no_versions[*]}"
            fi
            exit 1
          fi


      - name: Build and push images
        env:
          PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
          REGION: ${{ env.REGION }}
          AR_REPO: ${{ env.AR_REPO }}
        run: |
          set -euo pipefail
          INGEST_IMAGE="$REGION-docker.pkg.dev/$PROJECT_ID/$AR_REPO/ingest:${{ github.sha }}"
          PROCESSOR_IMAGE="$REGION-docker.pkg.dev/$PROJECT_ID/$AR_REPO/processor:${{ github.sha }}"
          APPROVER_IMAGE="$REGION-docker.pkg.dev/$PROJECT_ID/$AR_REPO/approver:${{ github.sha }}"

          docker build --progress=plain -t "$INGEST_IMAGE" -f services/ingest/Dockerfile .
          docker build --progress=plain -t "$PROCESSOR_IMAGE" -f services/processor/Dockerfile .
          docker build --progress=plain -t "$APPROVER_IMAGE" -f services/approver/Dockerfile .

          docker push "$INGEST_IMAGE"
          docker push "$PROCESSOR_IMAGE"
          docker push "$APPROVER_IMAGE"

      - name: Deploy Cloud Run services
        env:
          PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
          REGION: ${{ env.REGION }}
          AR_REPO: ${{ env.AR_REPO }}
          DB_INSTANCE_CONNECTION_NAME: ${{ env.DB_INSTANCE_CONNECTION_NAME }}
          DB_NAME: ${{ env.DB_NAME }}
          PUBSUB_TOPIC: ${{ env.PUBSUB_TOPIC }}
          DB_USER: ${{ secrets.DB_USER }}
          ADMIN_CHAT_ID: ${{ secrets.ADMIN_CHAT_ID || '-3277785413' }}
          TARGET_CHANNEL_ID: ${{ secrets.TARGET_CHANNEL_ID }}
        run: |
          set -euo pipefail
          TARGET_CHANNEL_ID="${TARGET_CHANNEL_ID:-$ADMIN_CHAT_ID}"
          APPROVER_IMAGE="$REGION-docker.pkg.dev/$PROJECT_ID/$AR_REPO/approver:${{ github.sha }}"

          gcloud run deploy approver --quiet \
            --image "$APPROVER_IMAGE" \
            --region "$REGION" \
            --platform managed \
            --allow-unauthenticated \
            --add-cloudsql-instances "$DB_INSTANCE_CONNECTION_NAME" \
            --set-env-vars DB_INSTANCE_CONNECTION_NAME="$DB_INSTANCE_CONNECTION_NAME",DB_NAME="$DB_NAME",DB_USER="$DB_USER",ADMIN_CHAT_ID="$ADMIN_CHAT_ID",TARGET_CHANNEL_ID="$TARGET_CHANNEL_ID" \
            --set-secrets DB_PASSWORD=DB_PASSWORD:latest,OPENAI_API_KEY=OPENAI_API_KEY:latest,TG_BOT_TOKEN=TG_BOT_TOKEN:latest

          APPROVER_URL="$(gcloud run services describe approver --region "$REGION" --format='value(status.url)')"
          PROCESSOR_IMAGE="$REGION-docker.pkg.dev/$PROJECT_ID/$AR_REPO/processor:${{ github.sha }}"

          gcloud run deploy processor \
            --image "$PROCESSOR_IMAGE" \
            --region "$REGION" \
            --platform managed \
            --allow-unauthenticated \
            --add-cloudsql-instances "$DB_INSTANCE_CONNECTION_NAME" \
            --set-env-vars DB_INSTANCE_CONNECTION_NAME="$DB_INSTANCE_CONNECTION_NAME",DB_NAME="$DB_NAME",DB_USER="$DB_USER",PUBSUB_TOPIC="$PUBSUB_TOPIC",APPROVER_NOTIFY_URL="$APPROVER_URL/internal/notify" \
            --set-secrets DB_PASSWORD=DB_PASSWORD:latest,OPENAI_API_KEY=OPENAI_API_KEY:latest

      - name: Update Cloud Run job
        env:
          PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
          REGION: ${{ env.REGION }}
          AR_REPO: ${{ env.AR_REPO }}
          DB_INSTANCE_CONNECTION_NAME: ${{ env.DB_INSTANCE_CONNECTION_NAME }}
          DB_NAME: ${{ env.DB_NAME }}
          PUBSUB_TOPIC: ${{ env.PUBSUB_TOPIC }}
          DB_USER: ${{ secrets.DB_USER }}
        run: |
          set -euo pipefail
          INGEST_IMAGE="$REGION-docker.pkg.dev/$PROJECT_ID/$AR_REPO/ingest:${{ github.sha }}"

          gcloud run jobs update ingest \
            --image "$INGEST_IMAGE" \
            --region "$REGION" \
            --add-cloudsql-instances "$DB_INSTANCE_CONNECTION_NAME" \
            --set-env-vars DB_INSTANCE_CONNECTION_NAME="$DB_INSTANCE_CONNECTION_NAME",DB_NAME="$DB_NAME",DB_USER="$DB_USER",PUBSUB_TOPIC="$PUBSUB_TOPIC" \
            --set-secrets DB_PASSWORD=DB_PASSWORD:latest,TELEGRAM_API_ID=TELEGRAM_API_ID:latest,TELEGRAM_API_HASH=TELEGRAM_API_HASH:latest,TELETHON_STRING_SESSION=TELETHON_STRING_SESSION:latest

      - name: Output URLs
        env:
          REGION: ${{ env.REGION }}
        run: |
          set -euo pipefail
          echo "Processor URL: $(gcloud run services describe processor --region $REGION --format='value(status.url)')"
          echo "Approver URL: $(gcloud run services describe approver --region $REGION --format='value(status.url)')"
